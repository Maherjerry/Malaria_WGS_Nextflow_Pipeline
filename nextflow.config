// Parameters
params {
    // Input/Output
    readDIR = "${projectDir}/data/fastq"
    outDIR = "./results"
    
    // Reference paths
    ref = "${projectDir}/data/reference/genome"
    known_sites = "${projectDir}/data/reference/known_sites"
    fasta = "${params.ref}/Pf_ref.fasta"
    adapter = "${params.ref}/TruSeq3-PE-2.fa"
    
    // Known sites VCFs
    REFSNP1 = "${params.known_sites}/3d7_hb3.combined.final.vcf.gz"
    REFSNP2 = "${params.known_sites}/7g8_gb4.combined.final.vcf.gz"
    REFSNP3 = "${params.known_sites}/hb3_dd2.combined.final.vcf.gz"
    
    // Trimming parameters
    trim_quality = 20
    trim_stringency = 3
    trim_length = 20
    trim_cores = 2
    
    // Alignment parameters
    bwa_threads = 4
    bwa_mem_params = "-M"
    
    // Resources
    cpus = 4
}

// Process-specific resources
process {
    // Default error strategy
    errorStrategy = { task.attempt <= 3 ? 'retry' : 'finish' }
    maxRetries = 3
    maxForks = 5

    withLabel: 'fastqc' {
        cpus = 1
        memory = '1 GB'
    }

    withLabel: 'trimming' {
        cpus = 2
        memory = '1 GB'
    }

    withLabel: 'qc' {
        cpus = 1
        memory = '1 GB'
    }

    withLabel: 'multiqc' {
        cpus = 1
        memory = '1 GB'
    }

    withLabel: 'reference' {
        cpus = 2
        memory = '2 GB'
    }

    withLabel: 'alignment' {
        cpus = 2
        memory = '2 GB'
    }

    withLabel: 'alignment_high_mem' {
        cpus = 4
        memory = { 4.GB * task.attempt }  // Start with 4GB, increase if needed
        time = { 8.hour * task.attempt }
    }

    withLabel: 'alignment_metrics' {
        cpus = 2
        memory = '2 GB'
    }

    withLabel: 'variant_calling' {
        cpus = 2
        memory = '2 GB'
    }

    withLabel: 'variant_calling_high_mem' {
        cpus = 2
        memory = { 4.GB * task.attempt }  // Reduced from 6GB to 4GB
    }

    // Configuration for VCF analysis processes
    withName: 'VCF_ANALYSIS' {
        cpus = 2
        memory = '4 GB'
        time = '1h'
    }
    
    withName: 'VCF_ANALYSIS_REPORT' {
        cpus = 1
        memory = '4 GB'  // R may need decent memory for data visualization
        time = '30m'
    }
}

// Execution reports
report {
    enabled = true
    file = "${params.outDIR}/pipeline_report.html"
    overwrite = true
}

timeline {
    enabled = true
    file = "${params.outDIR}/timeline.html"
    overwrite = true
}

trace {
    enabled = true
    file = "${params.outDIR}/trace.txt"
    overwrite = true
}

dag {
    enabled = true
    file = "${params.outDIR}/pipeline_info/pipeline_dag.svg"
    overwrite = true
}

// Manifest
manifest {
    name = 'WGS Analysis Pipeline'
    author = 'Your Name'
    description = 'WGS analysis pipeline for variant calling'
    version = '1.0.0'
    nextflowVersion = '>=24.10.0'
}

// Profiles for different environments
profiles {
    standard {
        process.executor = 'local'
    }
    cluster {
        process.executor = 'slurm'
        process.queue = 'normal'
    }
}

// If you're using containers, make sure the container has R and required packages:
// process.container = 'quay.io/biocontainers/vcf-toolkit:0.2.0--hdfd78af_1'
// or specify different containers for different processes:
// process {
//     withName: 'VCF_ANALYSIS' {
//         container = 'quay.io/biocontainers/vcf-toolkit:0.2.0--hdfd78af_1'
//     }
//     withName: 'VCF_ANALYSIS_REPORT' {
//         container = 'rocker/tidyverse:latest'  // Container with R and tidyverse packages
//     }
// }
