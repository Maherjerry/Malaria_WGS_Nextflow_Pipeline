// Parameters
params {
    // Input/Output
    readDIR = "${projectDir}/data/fastq"
    outDIR = "./results"
    
    // Reference paths
    ref = "${projectDir}/data/reference/genome"
    known_sites = "${projectDir}/data/reference/known_sites"
    fasta = "${params.ref}/Pf_ref.fasta"
    adapter = "${params.ref}/TruSeq3-PE-2.fa"
    
    // Known sites VCFs
    REFSNP1 = "${params.known_sites}/3d7_hb3.combined.final.vcf.gz"
    REFSNP2 = "${params.known_sites}/7g8_gb4.combined.final.vcf.gz"
    REFSNP3 = "${params.known_sites}/hb3_dd2.combined.final.vcf.gz"
    
    // Trimming parameters
    trim_quality = 20
    trim_stringency = 3
    trim_length = 20
    trim_cores = 2
    
    // Alignment parameters
    bwa_threads = 4
    bwa_mem_params = "-M"
    
    // Resources
    cpus = 4
}

// Process-specific resources
process {
    // Default error strategy
    errorStrategy = { task.attempt <= 3 ? 'retry' : 'finish' }
    maxRetries = 3
    maxForks = 5

    withLabel: 'fastqc' {
        cpus = 1
        memory = '1 GB'
    }

    withLabel: 'trimming' {
        cpus = 2
        memory = '1 GB'
    }

    withLabel: 'qc' {
        cpus = 1
        memory = '1 GB'
    }

    withLabel: 'multiqc' {
        cpus = 1
        memory = '1 GB'
    }

    withLabel: 'reference' {
        cpus = 2
        memory = '2 GB'
    }

    withLabel: 'alignment' {
        cpus = 2
        memory = '2 GB'
    }

    withLabel: 'alignment_high_mem' {
        cpus = 4
        memory = { 4.GB * task.attempt }  // Start with 4GB, increase if needed
        time = { 8.hour * task.attempt }
    }

    withLabel: 'alignment_metrics' {
        cpus = 2
        memory = '2 GB'
    }

    withLabel: 'variant_calling' {
        cpus = 2
        memory = '2 GB'
    }

    withLabel: 'variant_calling_high_mem' {
        cpus = 2
        memory = { 4.GB * task.attempt }  // Reduced from 6GB to 4GB
    }

    // Configuration for VCF analysis processes
    withName: 'VCF_ANALYSIS' {
        cpus = 2
        memory = '4 GB'
        time = '1h'
    }
    
    withName: 'VCF_ANALYSIS_REPORT' {
        cpus = 1
        memory = '4 GB'  // R may need decent memory for data visualization
        time = '30m'
    }
}

// Execution reports
report {
    enabled = true
    file = "${params.outDIR}/pipeline_report.html"
    overwrite = true
}

timeline {
    enabled = true
    file = "${params.outDIR}/timeline.html"
    overwrite = true
}

trace {
    enabled = true
    file = "${params.outDIR}/trace.txt"
    overwrite = true
}

dag {
    enabled = true
    file = "${params.outDIR}/pipeline_info/pipeline_dag.svg"
    overwrite = true
}

// Manifest
manifest {
    name = 'WGS Analysis Pipeline'
    author = 'Your Name'
    description = 'WGS analysis pipeline for variant calling'
    version = '1.0.0'
    nextflowVersion = '>=24.10.0'
}

// Profiles for different environments
profiles {
    standard {
        process.executor = 'local'
    }
    
    cluster {
        process.executor = 'slurm'
        process.queue = 'normal'
    }
    
    docker {
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g)'
        process.executor = 'local'
        
        process {
            // FastQC processes
            withLabel: 'fastqc' {
                container = 'biocontainers/fastqc:v0.11.9_cv8'
            }
            
            // MultiQC processes
            withLabel: 'multiqc' {
                container = 'ewels/multiqc:v1.14'
            }
            
            // Trimming processes
            withLabel: 'trimming' {
                container = 'quay.io/biocontainers/trim-galore:0.6.7--hdfd78af_0'
            }
            
            // Reference preparation and alignment
            withLabel: 'reference' {
                container = 'broadinstitute/gatk:4.4.0.0'
            }
            
            withLabel: 'alignment' {
                container = 'broadinstitute/gatk:4.4.0.0'
            }
            
            withLabel: 'alignment_high_mem' {
                container = 'broadinstitute/gatk:4.4.0.0'
            }
            
            withLabel: 'alignment_metrics' {
                container = 'broadinstitute/gatk:4.4.0.0'
            }
            
            // Variant calling processes
            withLabel: 'variant_calling' {
                container = 'broadinstitute/gatk:4.4.0.0'
            }
            
            withLabel: 'variant_calling_high_mem' {
                container = 'broadinstitute/gatk:4.4.0.0'
            }
            
            // VCF analysis - needs bcftools, vcftools, and R
            withName: 'VCF_ANALYSIS' {
                container = 'quay.io/biocontainers/mulled-v2-b3b32f424d6a13e8e78e56ffbfea6fe0:d79e7ef6f87e45159cd8bc1f0803c1b5e57f93f3-0'
            }
            
            withName: 'VCF_ANALYSIS_REPORT' {
                container = 'rocker/tidyverse:4.3.1'
            }
        }
    }
}

